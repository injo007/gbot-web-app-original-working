{% extends "base.html" %}

{% block title %}Settings - GBot Web{% endblock %}

{% block content %}
<div class="github-card">
    <div class="github-card-header">
        <h1 class="github-card-title">
            <i class="fas fa-cog"></i>
            Settings
        </h1>
        <p style="color: #656d76; margin: 8px 0 0 0; font-size: 14px;">
            Configure application settings and server connections
        </p>
    </div>

    <!-- Server Configuration Section -->
    <div class="github-card" style="margin-bottom: 24px;">
        <div class="github-card-header">
            <h3 class="github-card-title" style="font-size: 18px;">
                <i class="fas fa-server"></i>
                Server Configuration
            </h3>
        </div>
        <p style="color: #656d76; margin-bottom: 24px; font-size: 14px;">
            Configure the server connection for importing accounts from JSON files. 
            This server should contain the credential JSON files for Google Workspace accounts.
        </p>
        
        <form id="server-config-form">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div class="form-group-github">
                    <label for="server_host" class="form-label-github">
                        <i class="fas fa-globe"></i> Server Host/IP
                    </label>
                    <input type="text" class="form-control-github" id="server_host" 
                           placeholder="192.168.1.100 or server.domain.com" required>
                    <small style="color: #656d76; font-size: 12px;">
                        IP address or hostname of the server
                    </small>
                </div>
                <div class="form-group-github">
                    <label for="server_port" class="form-label-github">
                        <i class="fas fa-plug"></i> Port
                    </label>
                    <input type="number" class="form-control-github" id="server_port" 
                           value="22" min="1" max="65535" required>
                    <small style="color: #656d76; font-size: 12px;">
                        SSH port (default: 22)
                    </small>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div class="form-group-github">
                    <label for="server_username" class="form-label-github">
                        <i class="fas fa-user"></i> Username
                    </label>
                    <input type="text" class="form-control-github" id="server_username" 
                           placeholder="ubuntu or root" required>
                    <small style="color: #656d76; font-size: 12px;">
                        SSH username for server access
                    </small>
                </div>
                <div class="form-group-github">
                    <label for="server_auth_method" class="form-label-github">
                        <i class="fas fa-lock"></i> Authentication Method
                    </label>
                    <select class="form-control-github" id="server_auth_method" required>
                        <option value="password">Password</option>
                        <option value="key">SSH Key</option>
                    </select>
                    <small style="color: #656d76; font-size: 12px;">
                        Choose authentication method
                    </small>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div class="form-group-github" id="password-field">
                    <label for="server_password" class="form-label-github">
                        <i class="fas fa-key"></i> Password
                    </label>
                    <input type="password" class="form-control-github" id="server_password" 
                           placeholder="Server password">
                    <small style="color: #656d76; font-size: 12px;">
                        SSH password (if using password auth)
                    </small>
                </div>
                <div class="form-group-github" id="key-field" style="display: none;">
                    <label for="server_private_key" class="form-label-github">
                        <i class="fas fa-key"></i> Private Key
                    </label>
                    <textarea class="form-control-github" id="server_private_key" rows="4" 
                              placeholder="-----BEGIN OPENSSH PRIVATE KEY-----&#10;...&#10;-----END OPENSSH PRIVATE KEY-----" 
                              style="resize: vertical; font-family: 'Courier New', monospace; font-size: 12px;"></textarea>
                    <small style="color: #656d76; font-size: 12px;">
                        SSH private key content (if using key auth)
                    </small>
                </div>
            </div>
            
            <div class="form-group-github">
                <label for="server_json_path" class="form-label-github">
                    <i class="fas fa-folder"></i> JSON Files Directory Structure
                </label>
                <div style="background: #f6f8fa; border: 1px solid #d0d7de; border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                    <code style="color: #0969da; font-size: 14px;">/home/brightmindscampus/{account}/*.json</code>
                </div>
                <small style="color: #656d76; font-size: 12px;">
                    Each account has its own directory containing JSON credential files. The system will automatically look for JSON files in each account's directory.
                </small>
            </div>
            
            <div style="display: flex; gap: 16px; justify-content: center; margin-top: 24px;">
                <button type="button" class="btn-github" onclick="testServerConnection()">
                    <i class="fas fa-search"></i> Test Connection
                </button>
                <button type="submit" class="btn-github btn-github-primary">
                    <i class="fas fa-save"></i> Save Configuration
                </button>
            </div>
        </form>
    </div>

    <!-- OTP Generator SSH Settings Section -->
    <div class="github-card" style="margin-bottom: 24px;">
        <div class="github-card-header">
            <h3 class="github-card-title" style="font-size: 18px;">
                <i class="fas fa-key"></i>
                OTP Generator SSH Settings
            </h3>
        </div>
        <p style="color: #656d76; margin-bottom: 24px; font-size: 14px;">
            Configure the SSH server connection for OTP generation. This server should contain the authenticator secret key files for generating OTP codes.
        </p>
        
        <form id="otp-ssh-config-form">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div class="form-group-github">
                    <label for="otp_server_host" class="form-label-github">
                        <i class="fas fa-globe"></i> Server Host/IP
                    </label>
                    <input type="text" class="form-control-github" id="otp_server_host" 
                           placeholder="91.98.224.35" required>
                    <small style="color: #656d76; font-size: 12px;">
                        IP address or hostname of the OTP server
                    </small>
                </div>
                <div class="form-group-github">
                    <label for="otp_server_port" class="form-label-github">
                        <i class="fas fa-plug"></i> Port
                    </label>
                    <input type="number" class="form-control-github" id="otp_server_port" 
                           value="22" min="1" max="65535" required>
                    <small style="color: #656d76; font-size: 12px;">
                        SSH port (default: 22)
                    </small>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div class="form-group-github">
                    <label for="otp_server_username" class="form-label-github">
                        <i class="fas fa-user"></i> Username
                    </label>
                    <input type="text" class="form-control-github" id="otp_server_username" 
                           placeholder="root" required>
                    <small style="color: #656d76; font-size: 12px;">
                        SSH username for server access
                    </small>
                </div>
                <div class="form-group-github">
                    <label for="otp_server_auth_method" class="form-label-github">
                        <i class="fas fa-lock"></i> Authentication Method
                    </label>
                    <select class="form-control-github" id="otp_server_auth_method" required>
                        <option value="password">Password</option>
                        <option value="key">SSH Key</option>
                    </select>
                    <small style="color: #656d76; font-size: 12px;">
                        Choose authentication method
                    </small>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                <div class="form-group-github" id="otp_password_field">
                    <label for="otp_server_password" class="form-label-github">
                        <i class="fas fa-key"></i> Password
                    </label>
                    <input type="password" class="form-control-github" id="otp_server_password" 
                           placeholder="Server password">
                    <small style="color: #656d76; font-size: 12px;">
                        SSH password (if using password auth)
                    </small>
                </div>
                <div class="form-group-github" id="otp_key_field" style="display: none;">
                    <label for="otp_server_private_key" class="form-label-github">
                        <i class="fas fa-key"></i> Private Key
                    </label>
                    <textarea class="form-control-github" id="otp_server_private_key" rows="4" 
                              placeholder="-----BEGIN OPENSSH PRIVATE KEY-----&#10;...&#10;-----END OPENSSH PRIVATE KEY-----" 
                              style="resize: vertical; font-family: 'Courier New', monospace; font-size: 12px;"></textarea>
                    <small style="color: #656d76; font-size: 12px;">
                        SSH private key content (if using key auth)
                    </small>
                </div>
            </div>
            
            <div class="form-group-github">
                <label for="otp_secret_keys_path" class="form-label-github">
                    <i class="fas fa-folder"></i> Secret Keys Directory Structure
                </label>
                <div style="background: #f6f8fa; border: 1px solid #d0d7de; border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                    <code style="color: #0969da; font-size: 14px;">/home/brightmindscampus/{account}/{account}_authenticator_secret_key.txt</code>
                </div>
                <small style="color: #656d76; font-size: 12px;">
                    Each account has its own directory containing the authenticator secret key file. The system will automatically look for the secret key file in each account's directory.
                </small>
            </div>
            
            <div style="display: flex; gap: 16px; justify-content: center; margin-top: 24px;">
                <button type="button" class="btn-github" onclick="testOTPServerConnection()">
                    <i class="fas fa-search"></i> Test Connection
                </button>
                <button type="submit" class="btn-github btn-github-primary">
                    <i class="fas fa-save"></i> Save OTP Settings
                </button>
            </div>
        </form>
    </div>

    <!-- Database Backup Section -->
    <div class="github-card" style="margin-bottom: 24px;">
        <div class="github-card-header">
            <h3 class="github-card-title" style="font-size: 18px;">
                <i class="fas fa-database"></i>
                Database Backup
            </h3>
        </div>
        <p style="color: #656d76; margin-bottom: 24px; font-size: 14px;">
            Create and download complete database backups. This will backup the entire database including all users, accounts, tokens, and configurations.
        </p>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
            <div class="form-group-github">
                <label for="backup_format" class="form-label-github">
                    <i class="fas fa-file-code"></i> Backup Format
                </label>
                <select class="form-control-github" id="backup_format">
                    <option value="sql">SQL Dump (.sql)</option>
                    <option value="json">JSON Export (.json)</option>
                    <option value="csv">CSV Export (.csv)</option>
                </select>
                <small style="color: #656d76; font-size: 12px;">
                    Choose the format for your database backup
                </small>
            </div>
            <div class="form-group-github">
                <label for="backup_include_data" class="form-label-github">
                    <i class="fas fa-check-square"></i> Include Data
                </label>
                <select class="form-control-github" id="backup_include_data">
                    <option value="full">Full Backup (Schema + Data)</option>
                    <option value="schema">Schema Only</option>
                    <option value="data">Data Only</option>
                </select>
                <small style="color: #656d76; font-size: 12px;">
                    Choose what to include in the backup
                </small>
            </div>
        </div>
        
        <div style="display: flex; gap: 16px; justify-content: center; margin-bottom: 24px;">
            <button type="button" class="btn-github btn-github-primary" onclick="createDatabaseBackup()">
                <i class="fas fa-database"></i> Create Database Backup
            </button>
            <button type="button" class="btn-github" onclick="testDatabaseBackup()">
                <i class="fas fa-search"></i> Test Backup System
            </button>
            <button type="button" class="btn-github" onclick="refreshBackupFiles()">
                <i class="fas fa-sync-alt"></i> Refresh Backup List
            </button>
        </div>
        
        <div id="backup-progress" style="display: none; margin-bottom: 24px;">
            <div class="status-info" style="background: #fff3cd; border-color: #ffeaa7;">
                <p><strong>üîÑ Creating Database Backup</strong></p>
                <p id="backup-progress-text">Preparing backup...</p>
                <div style="background: #f6f8fa; border-radius: 6px; height: 8px; margin-top: 8px; overflow: hidden;">
                    <div id="backup-progress-bar" style="background: #0969da; height: 100%; width: 0%; transition: width 0.3s; border-radius: 6px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Available Backups -->
    <div class="github-card" style="margin-bottom: 24px;">
        <div class="github-card-header">
            <h3 class="github-card-title" style="font-size: 18px;">
                <i class="fas fa-archive"></i>
                Available Database Backups
            </h3>
        </div>
        <p style="color: #656d76; margin-bottom: 24px; font-size: 14px;">
            Download previously created database backups. Backups are stored on the server and can be downloaded.
        </p>
        
        <div id="backup-files-list" style="margin-bottom: 24px;">
            <div style="text-align: center; padding: 40px; color: #656d76;">
                <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>
                Loading backup files...
            </div>
        </div>
        
        <div style="display: flex; gap: 16px; justify-content: center;">
            <button type="button" class="btn-github" onclick="refreshBackupFiles()">
                <i class="fas fa-sync-alt"></i> Refresh Backup List
            </button>
            <button type="button" class="btn-github btn-github-danger" onclick="cleanupOldBackups()">
                <i class="fas fa-trash"></i> Cleanup Old Backups
            </button>
        </div>
    </div>

    <!-- Database Restore Section -->
    <div class="github-card" style="margin-bottom: 24px;">
        <div class="github-card-header">
            <h3 class="github-card-title" style="font-size: 18px;">
                <i class="fas fa-undo"></i>
                Database Restore
            </h3>
        </div>
        <p style="color: #656d76; margin-bottom: 24px; font-size: 14px;">
            Restore your database from a previous backup. You can either select from existing backups or upload a new backup file.
        </p>
        
        <!-- Restore Options -->
        <div style="margin-bottom: 24px;">
            <div class="form-group-github">
                <label class="form-label-github">
                    <i class="fas fa-list"></i> Restore Method
                </label>
                <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="radio" name="restore_method" value="existing" checked style="margin-right: 8px;">
                        <span>Select from existing backups</span>
                    </label>
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="radio" name="restore_method" value="upload" style="margin-right: 8px;">
                        <span>Upload backup file</span>
                    </label>
                </div>
            </div>
        </div>
        
        <!-- Existing Backup Selection -->
        <div id="existing-backup-section">
            <div class="form-group-github">
                <label for="backup_select" class="form-label-github">
                    <i class="fas fa-archive"></i> Select Backup File
                </label>
                <select class="form-control-github" id="backup_select">
                    <option value="">Loading backup files...</option>
                </select>
                <small style="color: #656d76; font-size: 12px;">
                    Choose a backup file to restore from
                </small>
            </div>
        </div>
        
        <!-- Upload Backup Section -->
        <div id="upload-backup-section" style="display: none;">
            <div class="form-group-github">
                <label for="backup_file" class="form-label-github">
                    <i class="fas fa-upload"></i> Upload Backup File
                </label>
                <input type="file" class="form-control-github" id="backup_file" accept=".sql,.db,.json,.tar.gz">
                <small style="color: #656d76; font-size: 12px;">
                    Supported formats: .sql, .db, .json, .tar.gz
                </small>
            </div>
        </div>
        
        <!-- Restore Progress -->
        <div id="restore-progress" style="display: none; margin-bottom: 24px;">
            <div class="status-info" style="background: #fff3cd; border-color: #ffeaa7;">
                <p><strong>üîÑ Restoring Database</strong></p>
                <p id="restore-progress-text">Preparing restore...</p>
                <div style="background: #f6f8fa; border-radius: 6px; height: 8px; margin-top: 8px; overflow: hidden;">
                    <div id="restore-progress-bar" style="background: #0969da; height: 100%; width: 0%; transition: width 0.3s; border-radius: 6px;"></div>
                </div>
            </div>
        </div>
        
        <!-- Restore Actions -->
        <div style="display: flex; gap: 16px; justify-content: center; margin-bottom: 24px;">
            <button type="button" class="btn-github btn-github-warning" onclick="restoreDatabase()">
                <i class="fas fa-undo"></i> Restore Database
            </button>
            <button type="button" class="btn-github" onclick="refreshBackupList()">
                <i class="fas fa-sync-alt"></i> Refresh Backup List
            </button>
            <button type="button" class="btn-github" onclick="testChunkedUpload()" style="background: #6f42c1;">
                <i class="fas fa-bug"></i> Test Chunked Upload
            </button>
        </div>
        
        <!-- Warning Message -->
        <div class="status-warning" style="margin-bottom: 24px;">
            <p><strong>‚ö†Ô∏è Important Warning</strong></p>
            <p>Restoring a database will completely replace your current database with the backup data. This action cannot be undone. A backup of your current database will be created automatically before the restore process begins.</p>
        </div>
    </div>

    <!-- Bulk Account Upload Section -->
    <div class="github-card" style="margin-bottom: 24px;">
        <div class="github-card-header">
            <h3 class="github-card-title" style="font-size: 18px;">
                <i class="fas fa-upload"></i>
                Bulk Account Upload
            </h3>
        </div>
        <p style="color: #656d76; margin-bottom: 24px; font-size: 14px;">
            Upload authenticated Google Workspace accounts in JSON format. The accounts will be automatically added to the system with their tokens.
        </p>
        
        <div class="form-group-github">
            <label for="bulk-json-upload" class="form-label-github">
                <i class="fas fa-file-code"></i> Upload JSON File
            </label>
            <input type="file" class="form-control-github" id="bulk-json-upload" accept=".json" 
                   style="padding: 12px; border: 2px dashed #d0d7de; background: #f6f8fa;">
            <small style="color: #656d76; font-size: 12px;">
                Select a JSON file containing authenticated Google accounts with tokens, refresh tokens, and credentials.
            </small>
        </div>
        
        <div id="json-preview" style="display: none; margin: 16px 0;">
            <h6 style="font-weight: 600; margin-bottom: 8px; color: #24292f;">
                <i class="fas fa-eye"></i> Preview
            </h6>
            <div id="json-preview-content" style="background: #f6f8fa; padding: 16px; border-radius: 6px; border: 1px solid #d0d7de; max-height: 200px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px;">
            </div>
        </div>
        
        <div style="display: flex; gap: 16px; justify-content: center; margin-top: 24px;">
            <button type="button" id="validate-json-btn" class="btn-github" onclick="validateJsonFile()" disabled>
                <i class="fas fa-check"></i> Validate JSON
            </button>
            <button type="button" id="upload-accounts-btn" class="btn-github btn-github-primary" onclick="uploadBulkAccounts()" disabled>
                <i class="fas fa-upload"></i> Upload Accounts
            </button>
        </div>
        
        <div id="upload-results" style="display: none; margin-top: 24px;">
            <h6 style="font-weight: 600; margin-bottom: 16px; color: #24292f;">
                <i class="fas fa-list-check"></i> Upload Results
            </h6>
            <div id="upload-results-content" style="background: #f6f8fa; padding: 16px; border-radius: 6px; border: 1px solid #d0d7de;">
            </div>
        </div>
    </div>

    <!-- Current Configuration Display -->
    <div class="github-card">
        <div class="github-card-header">
            <h3 class="github-card-title" style="font-size: 18px;">
                <i class="fas fa-list"></i>
                Current Configuration
            </h3>
        </div>
        <div id="current-config-display">
            <div style="display: flex; align-items: center; justify-content: center; padding: 40px; color: #656d76;">
                <i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>
                Loading current configuration...
            </div>
        </div>
    </div>

    <!-- Status Messages -->
    <div id="status-messages" style="margin-top: 24px;"></div>
</div>

<!-- Test Connection Modal -->
<div class="modal fade" id="testConnectionModal" tabindex="-1" aria-labelledby="testModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border: 1px solid #d0d7de; border-radius: 12px;">
            <div class="modal-header" style="background: #0969da; color: white; border-radius: 12px 12px 0 0; border-bottom: none; padding: 20px;">
                <h5 class="modal-title w-100" id="testModalLabel" style="text-align: center; margin: 0; font-weight: 600;">
                    <i class="fas fa-search"></i>
                    Testing Server Connection
                </h5>
            </div>
            <div class="modal-body" style="text-align: center; padding: 32px;">
                <div style="margin-bottom: 24px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #0969da;"></i>
                </div>
                <p style="font-size: 16px; margin-bottom: 16px;">Testing connection to server...</p>
                <div id="test-progress" style="display: none; background: #f6f8fa; border-radius: 6px; height: 8px; margin-top: 16px; overflow: hidden;">
                    <div style="background: #0969da; height: 100%; width: 0%; transition: width 0.3s; border-radius: 6px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    console.log('Settings page loaded, initializing...');
    
    // Load current configuration
    loadCurrentConfiguration();
    
    // Load OTP SSH configuration
    loadOTPSSHConfiguration();
    
    // Handle authentication method change
    $('#server_auth_method').change(function() {
        const method = $(this).val();
        if (method === 'password') {
            $('#password-field').show();
            $('#key-field').hide();
            $('#server_password').prop('required', true);
            $('#server_private_key').prop('required', false);
        } else {
            $('#password-field').hide();
            $('#key-field').show();
            $('#server_password').prop('required', false);
            $('#server_private_key').prop('required', true);
        }
    });
    
    // Handle OTP authentication method change
    $('#otp_server_auth_method').change(function() {
        const method = $(this).val();
        if (method === 'password') {
            $('#otp_password_field').show();
            $('#otp_key_field').hide();
            $('#otp_server_password').prop('required', true);
            $('#otp_server_private_key').prop('required', false);
        } else {
            $('#otp_password_field').hide();
            $('#otp_key_field').show();
            $('#otp_server_password').prop('required', false);
            $('#otp_server_private_key').prop('required', true);
        }
    });
    
    // Handle form submission
    $('#server-config-form').submit(function(e) {
        e.preventDefault();
        saveServerConfiguration();
    });
    
    // Handle OTP form submission
    $('#otp-ssh-config-form').submit(function(e) {
        e.preventDefault();
        saveOTPSSHConfiguration();
    });
    
    // Handle file upload
    $('#bulk-json-upload').change(function(e) {
        handleJsonFileSelection(e);
    });
    
    // Load backup files
    loadBackupFiles();
    
    // Load backup list for restore
    loadBackupList();
    
    // Restore method toggle
    $('input[name="restore_method"]').change(function() {
        const method = $(this).val();
        if (method === 'existing') {
            $('#existing-backup-section').show();
            $('#upload-backup-section').hide();
        } else {
            $('#existing-backup-section').hide();
            $('#upload-backup-section').show();
        }
    });
});

function loadCurrentConfiguration() {
    console.log('Loading current server configuration...');
    
    fetch('/api/get-server-config', {
        method: 'GET',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.config) {
            displayCurrentConfiguration(data.config);
        } else {
            displayCurrentConfiguration(null);
        }
    })
    .catch(error => {
        console.error('Error loading configuration:', error);
        displayCurrentConfiguration(null);
    });
}

function loadOTPSSHConfiguration() {
    console.log('Loading OTP SSH configuration...');
    
    fetch('/api/get-otp-ssh-config', {
        method: 'GET',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.config) {
            // Populate OTP form fields
            $('#otp_server_host').val(data.config.host || '');
            $('#otp_server_port').val(data.config.port || 22);
            $('#otp_server_username').val(data.config.username || '');
            $('#otp_server_auth_method').val(data.config.auth_method || 'password');
            
            // Trigger auth method change to show/hide fields
            $('#otp_server_auth_method').trigger('change');
            
            console.log('OTP SSH configuration loaded:', data.config);
        } else {
            console.log('No OTP SSH configuration found');
        }
    })
    .catch(error => {
        console.error('Error loading OTP SSH configuration:', error);
    });
}

function displayCurrentConfiguration(config) {
    const display = $('#current-config-display');
    
    if (!config) {
        display.html(`
            <div style="text-align: center; padding: 40px; color: #656d76;">
                <i class="fas fa-cog" style="font-size: 48px; margin-bottom: 16px; color: #d0d7de;"></i>
                <h5 style="color: #656d76; margin-bottom: 8px;">No Configuration Set</h5>
                <p style="color: #656d76;">Configure server settings above to enable "Add from Server JSON" functionality.</p>
            </div>
        `);
        return;
    }
    
    // Populate form fields
    $('#server_host').val(config.host || '');
    $('#server_port').val(config.port || 22);
    $('#server_username').val(config.username || '');
    $('#server_auth_method').val(config.auth_method || 'password');
    $('#server_password').val(config.password || '');
    $('#server_private_key').val(config.private_key || '');
    
    // Trigger auth method change to show/hide fields
    $('#server_auth_method').trigger('change');
    
    // Display current config
    const statusColor = config.is_configured ? '#2da44e' : '#fb8500';
    const statusIcon = config.is_configured ? 'fas fa-check-circle' : 'fas fa-exclamation-triangle';
    const statusText = config.is_configured ? 'Configured' : 'Not Tested';
    
    display.html(`
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
            <div>
                <h6 style="font-weight: 600; margin-bottom: 16px; color: #24292f;">
                    <i class="fas fa-server"></i> Server Details
                </h6>
                <div style="background: #f6f8fa; padding: 16px; border-radius: 6px; border: 1px solid #d0d7de;">
                    <div style="margin-bottom: 8px;"><strong>Host:</strong> <code>${config.host || 'Not set'}</code></div>
                    <div style="margin-bottom: 8px;"><strong>Port:</strong> <code>${config.port || 'Not set'}</code></div>
                    <div style="margin-bottom: 8px;"><strong>Username:</strong> <code>${config.username || 'Not set'}</code></div>
                    <div><strong>Auth Method:</strong> <code>${config.auth_method || 'Not set'}</code></div>
                </div>
            </div>
            <div>
                <h6 style="font-weight: 600; margin-bottom: 16px; color: #24292f;">
                    <i class="fas fa-folder"></i> Directory Structure
                </h6>
                <div style="background: #f6f8fa; padding: 16px; border-radius: 6px; border: 1px solid #d0d7de;">
                    <div style="margin-bottom: 8px;"><strong>Base Path:</strong> <code>/home/brightmindscampus</code></div>
                    <div style="margin-bottom: 8px;"><strong>Account Pattern:</strong> <code>{account}/*.json</code></div>
                    <div style="margin-bottom: 8px;"><strong>Example:</strong> <code>/home/brightmindscampus/support@example.com/client_secret.json</code></div>
                    <div><strong>Status:</strong> 
                        <span style="display: inline-flex; align-items: center; gap: 4px; background: ${statusColor}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">
                            <i class="${statusIcon}"></i> ${statusText}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div style="text-align: center;">
            <button class="btn-github btn-github-danger" onclick="clearServerConfiguration()" style="padding: 4px 16px; font-size: 12px;">
                <i class="fas fa-trash"></i> Clear Configuration
            </button>
        </div>
    `);
}

function saveServerConfiguration() {
    console.log('Saving server configuration...');
    
    const config = {
        host: $('#server_host').val().trim(),
        port: parseInt($('#server_port').val()),
        username: $('#server_username').val().trim(),
        auth_method: $('#server_auth_method').val(),
        password: $('#server_password').val(),
        private_key: $('#server_private_key').val().trim()
    };
    
    // Validate required fields - updated for new structure
    if (!config.host || !config.username) {
        showStatus('Please fill in all required fields', 'error');
        return;
    }
    
    if (config.auth_method === 'password' && !config.password) {
        showStatus('Password is required when using password authentication', 'error');
        return;
    }
    
    if (config.auth_method === 'key' && !config.private_key) {
        showStatus('Private key is required when using SSH key authentication', 'error');
        return;
    }
    
    showStatus('Saving server configuration...', 'info');
    
    fetch('/api/save-server-config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('‚úÖ Server configuration saved successfully', 'success');
            loadCurrentConfiguration();
        } else {
            showStatus('‚ùå Failed to save configuration: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error saving configuration:', error);
        showStatus('‚ùå Network error: ' + error, 'error');
    });
}

function testServerConnection() {
    console.log('Testing server connection...');
    
    const config = {
        host: $('#server_host').val().trim(),
        port: parseInt($('#server_port').val()),
        username: $('#server_username').val().trim(),
        auth_method: $('#server_auth_method').val(),
        password: $('#server_password').val(),
        private_key: $('#server_private_key').val().trim()
    };
    
    // Validate required fields - updated for new structure
    if (!config.host || !config.username) {
        showStatus('Please fill in all required fields before testing', 'error');
        return;
    }
    
    if (config.auth_method === 'password' && !config.password) {
        showStatus('Password is required when using password authentication', 'error');
        return;
    }
    
    if (config.auth_method === 'key' && !config.private_key) {
        showStatus('Private key is required when using SSH key authentication', 'error');
        return;
    }
    
    // Show test modal
    const modal = new bootstrap.Modal(document.getElementById('testConnectionModal'));
    modal.show();
    
    // Start progress bar
    $('#test-progress').show();
    const progressBar = $('#test-progress .progress-bar');
    progressBar.css('width', '0%');
    
    // Simulate progress
    let progress = 0;
    const progressInterval = setInterval(() => {
        progress += 10;
        progressBar.css('width', progress + '%');
        if (progress >= 90) clearInterval(progressInterval);
    }, 200);
    
    fetch('/api/test-server-connection', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(config)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        clearInterval(progressInterval);
        progressBar.css('width', '100%');
        
        setTimeout(() => {
            try {
                modal.hide();
            } catch (e) {
                console.warn('Modal hide failed, forcing close:', e);
                window.forceCloseAllModals();
            }
            
            if (data.success) {
                showStatus('‚úÖ ' + data.message, 'success');
                loadCurrentConfiguration();
            } else {
                showStatus('‚ùå Connection failed: ' + data.error, 'error');
            }
        }, 500);
    })
    .catch(error => {
        clearInterval(progressInterval);
        try {
            modal.hide();
        } catch (e) {
            console.warn('Modal hide failed, forcing close:', e);
            window.forceCloseAllModals();
        }
        console.error('Error testing connection:', error);
        showStatus('‚ùå Network error: ' + error.message, 'error');
    });
}

function clearServerConfiguration() {
    if (!confirm('Are you sure you want to clear the server configuration? This will disable the "Add from Server JSON" functionality.')) {
        return;
    }
    
    console.log('Clearing server configuration...');
    
    fetch('/api/clear-server-config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('‚úÖ Server configuration cleared', 'success');
            loadCurrentConfiguration();
        } else {
            showStatus('‚ùå Failed to clear configuration: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error clearing configuration:', error);
        showStatus('‚ùå Network error: ' + error, 'error');
    });
}

function showStatus(message, type) {
    console.log('Showing status:', message, type);
    var bgColor = type === 'success' ? '#dafbe1' : 
                 type === 'error' ? '#ffebe9' : 
                 type === 'warning' ? '#fff8c5' : '#dbeafe';
    
    var borderColor = type === 'success' ? '#2da44e' : 
                     type === 'error' ? '#da3633' : 
                     type === 'warning' ? '#d1242f' : '#0969da';
    
    var textColor = type === 'success' ? '#1a7f37' : 
                   type === 'error' ? '#cf222e' : 
                   type === 'warning' ? '#7d4e00' : '#0969da';
    
    var icon = type === 'success' ? 'fas fa-check-circle' : 
              type === 'error' ? 'fas fa-exclamation-circle' : 
              type === 'warning' ? 'fas fa-exclamation-triangle' : 'fas fa-info-circle';
    
    var statusHtml = '<div class="alert-github" style="background: ' + bgColor + '; border: 1px solid ' + borderColor + '; color: ' + textColor + '; display: flex; align-items: center; gap: 8px; padding: 16px; border-radius: 6px;">' +
                     '<i class="' + icon + '"></i>' +
                     '<span>' + message + '</span>' +
                     '<button type="button" onclick="this.parentElement.style.display=\'none\'" style="background: none; border: none; color: ' + textColor + '; cursor: pointer; margin-left: auto; padding: 4px; font-size: 16px;">√ó</button>' +
                     '</div>';
    
    $('#status-messages').html(statusHtml);
    
    // Auto-hide success messages after 5 seconds
    if (type === 'success') {
        setTimeout(function() {
            $('#status-messages .alert-github').fadeOut();
        }, 5000);
    }
}

// Global variables for bulk upload
let selectedJsonFile = null;
let parsedJsonData = null;

function handleJsonFileSelection(event) {
    const file = event.target.files[0];
    if (!file) {
        resetBulkUploadUI();
        return;
    }
    
    selectedJsonFile = file;
    
    // Validate file type
    if (!file.name.toLowerCase().endsWith('.json')) {
        showStatus('‚ùå Please select a valid JSON file', 'error');
        resetBulkUploadUI();
        return;
    }
    
    // Read and parse the file
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const jsonContent = e.target.result;
            parsedJsonData = JSON.parse(jsonContent);
            
            // Show preview
            showJsonPreview(jsonContent);
            
            // Enable validation button
            $('#validate-json-btn').prop('disabled', false);
            
            showStatus('üìÑ JSON file loaded successfully', 'info');
            
        } catch (error) {
            showStatus('‚ùå Invalid JSON format: ' + error.message, 'error');
            resetBulkUploadUI();
        }
    };
    
    reader.onerror = function() {
        showStatus('‚ùå Failed to read file', 'error');
        resetBulkUploadUI();
    };
    
    reader.readAsText(file);
}

function showJsonPreview(jsonContent) {
    const preview = $('#json-preview');
    const content = $('#json-preview-content');
    
    // Show first 500 characters of JSON with formatting
    let previewText = jsonContent;
    if (previewText.length > 500) {
        previewText = previewText.substring(0, 500) + '...';
    }
    
    // Basic syntax highlighting for JSON
    previewText = previewText
        .replace(/(".*?")/g, '<span style="color: #032f62;">$1</span>')
        .replace(/(true|false|null)/g, '<span style="color: #005cc5;">$1</span>')
        .replace(/(\d+)/g, '<span style="color: #005cc5;">$1</span>');
    
    content.html('<pre style="margin: 0; white-space: pre-wrap;">' + previewText + '</pre>');
    preview.show();
}

function validateJsonFile() {
    if (!parsedJsonData) {
        showStatus('‚ùå No JSON data to validate', 'error');
        return;
    }
    
    try {
        const accounts = Object.keys(parsedJsonData);
        const validAccounts = [];
        const invalidAccounts = [];
        
        // Validate each account structure
        for (const email of accounts) {
            const accountData = parsedJsonData[email];
            
            // Check required fields for authenticated accounts
            const requiredFields = ['token', 'refresh_token', 'token_uri', 'client_id', 'client_secret', 'scopes'];
            const missingFields = requiredFields.filter(field => !accountData[field]);
            
            if (missingFields.length === 0) {
                // Validate email format
                if (email.includes('@')) {
                    validAccounts.push(email);
                } else {
                    invalidAccounts.push({email, error: 'Invalid email format'});
                }
            } else {
                invalidAccounts.push({email, error: `Missing fields: ${missingFields.join(', ')}`});
            }
        }
        
        // Show validation results
        let validationHtml = `
            <div style="margin-bottom: 16px;">
                <strong>Validation Results:</strong>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div>
                    <h6 style="color: #2da44e; margin-bottom: 8px;">
                        <i class="fas fa-check-circle"></i> Valid Accounts (${validAccounts.length})
                    </h6>
                    <div style="background: #dafbe1; padding: 8px; border-radius: 4px; border: 1px solid #2da44e; max-height: 150px; overflow-y: auto;">
        `;
        
        if (validAccounts.length > 0) {
            validAccounts.forEach(email => {
                validationHtml += `<div style="font-size: 12px; margin-bottom: 4px;">‚úÖ ${email}</div>`;
            });
        } else {
            validationHtml += `<div style="color: #656d76; font-style: italic;">No valid accounts found</div>`;
        }
        
        validationHtml += `
                    </div>
                </div>
                <div>
                    <h6 style="color: #da3633; margin-bottom: 8px;">
                        <i class="fas fa-exclamation-circle"></i> Invalid Accounts (${invalidAccounts.length})
                    </h6>
                    <div style="background: #ffebe9; padding: 8px; border-radius: 4px; border: 1px solid #da3633; max-height: 150px; overflow-y: auto;">
        `;
        
        if (invalidAccounts.length > 0) {
            invalidAccounts.forEach(item => {
                validationHtml += `<div style="font-size: 12px; margin-bottom: 4px;">‚ùå ${item.email}: ${item.error}</div>`;
            });
        } else {
            validationHtml += `<div style="color: #656d76; font-style: italic;">No invalid accounts</div>`;
        }
        
        validationHtml += `
                    </div>
                </div>
            </div>
        `;
        
        // Show results
        $('#upload-results-content').html(validationHtml);
        $('#upload-results').show();
        
        // Enable upload button if there are valid accounts
        if (validAccounts.length > 0) {
            $('#upload-accounts-btn').prop('disabled', false);
            showStatus(`‚úÖ Validation complete: ${validAccounts.length} valid accounts found`, 'success');
        } else {
            $('#upload-accounts-btn').prop('disabled', true);
            showStatus('‚ùå No valid accounts found in the JSON file', 'error');
        }
        
    } catch (error) {
        showStatus('‚ùå Validation error: ' + error.message, 'error');
    }
}

function uploadBulkAccounts() {
    if (!parsedJsonData) {
        showStatus('‚ùå No JSON data to upload', 'error');
        return;
    }
    
    // Confirm upload
    const accountCount = Object.keys(parsedJsonData).length;
    if (!confirm(`Are you sure you want to upload ${accountCount} accounts? This will add them to the database with their authentication tokens.`)) {
        return;
    }
    
    // Disable upload button and show loading
    $('#upload-accounts-btn').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Uploading...');
    
    showStatus('üîÑ Uploading accounts...', 'info');
    
    // Send to backend
    fetch('/api/bulk-upload-authenticated-accounts', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({accounts: parsedJsonData})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show detailed results
            let resultsHtml = `
                <div style="margin-bottom: 16px;">
                    <strong>Upload Complete:</strong>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div>
                        <h6 style="color: #2da44e; margin-bottom: 8px;">
                            <i class="fas fa-check-circle"></i> Successfully Added (${data.added_count})
                        </h6>
                        <div style="background: #dafbe1; padding: 8px; border-radius: 4px; border: 1px solid #2da44e; max-height: 150px; overflow-y: auto;">
            `;
            
            if (data.added_accounts && data.added_accounts.length > 0) {
                data.added_accounts.forEach(email => {
                    resultsHtml += `<div style="font-size: 12px; margin-bottom: 4px;">‚úÖ ${email}</div>`;
                });
            } else {
                resultsHtml += `<div style="color: #656d76; font-style: italic;">No accounts added</div>`;
            }
            
            resultsHtml += `
                        </div>
                    </div>
                    <div>
                        <h6 style="color: #da3633; margin-bottom: 8px;">
                            <i class="fas fa-exclamation-circle"></i> Failed (${data.failed_accounts ? data.failed_accounts.length : 0})
                        </h6>
                        <div style="background: #ffebe9; padding: 8px; border-radius: 4px; border: 1px solid #da3633; max-height: 150px; overflow-y: auto;">
            `;
            
            if (data.failed_accounts && data.failed_accounts.length > 0) {
                data.failed_accounts.forEach(item => {
                    resultsHtml += `<div style="font-size: 12px; margin-bottom: 4px;">‚ùå ${item.email}: ${item.error}</div>`;
                });
            } else {
                resultsHtml += `<div style="color: #656d76; font-style: italic;">No failed accounts</div>`;
            }
            
            resultsHtml += `
                        </div>
                    </div>
                </div>
            `;
            
            $('#upload-results-content').html(resultsHtml);
            $('#upload-results').show();
            
            showStatus(`‚úÖ ${data.message}`, 'success');
            
            // Reset form after successful upload
            setTimeout(() => {
                resetBulkUploadUI();
            }, 3000);
            
        } else {
            showStatus('‚ùå Upload failed: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        showStatus('‚ùå Network error: ' + error.message, 'error');
    })
    .finally(() => {
        // Re-enable upload button
        $('#upload-accounts-btn').prop('disabled', false).html('<i class="fas fa-upload"></i> Upload Accounts');
    });
}

function resetBulkUploadUI() {
    selectedJsonFile = null;
    parsedJsonData = null;
    
    $('#bulk-json-upload').val('');
    $('#json-preview').hide();
    $('#upload-results').hide();
    $('#validate-json-btn').prop('disabled', true);
    $('#upload-accounts-btn').prop('disabled', true);
}

// Database Backup Functions
function createDatabaseBackup() {
    console.log('Creating database backup...');
    
    const backupFormat = $('#backup_format').val();
    const includeData = $('#backup_include_data').val();
    
    // Show progress
    $('#backup-progress').show();
    updateBackupProgress(10, 'Initializing backup...');
    
    showStatus('Creating database backup...', 'info');
    
    fetch('/api/create-database-backup', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            format: backupFormat,
            include_data: includeData
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            updateBackupProgress(100, 'Backup completed successfully!');
            showStatus('‚úÖ Database backup created successfully: ' + data.filename, 'success');
            
            // Hide progress after 3 seconds
            setTimeout(() => {
                $('#backup-progress').hide();
            }, 3000);
            
            // Refresh backup files list
            loadBackupFiles();
        } else {
            $('#backup-progress').hide();
            showStatus('‚ùå Failed to create backup: ' + data.error, 'error');
        }
    })
    .catch(error => {
        $('#backup-progress').hide();
        console.error('Error creating database backup:', error);
        showStatus('‚ùå Network error: ' + error, 'error');
    });
}

function updateBackupProgress(percentage, message) {
    $('#backup-progress-bar').css('width', percentage + '%');
    $('#backup-progress-text').text(message);
}

function testDatabaseBackup() {
    console.log('Testing database backup system...');
    
    showStatus('Testing database backup system...', 'info');
    
    fetch('/api/test-database-backup', {
        method: 'GET',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const results = data.test_results;
            let statusMessage = 'üîç Database Backup System Test Results:\n\n';
            
            statusMessage += `üìä Database Type: ${results.database_type}\n`;
            statusMessage += `üîó Database URL: ${results.database_url}\n\n`;
            
            statusMessage += `üóÑÔ∏è pg_dump Available: ${results.pg_dump_available ? '‚úÖ Yes' : '‚ùå No'}\n`;
            if (results.pg_dump_version) {
                statusMessage += `üì¶ pg_dump Version: ${results.pg_dump_version}\n`;
            }
            if (results.pg_dump_error) {
                statusMessage += `‚ö†Ô∏è pg_dump Error: ${results.pg_dump_error}\n`;
            }
            
            statusMessage += `\nüîå Database Connection: ${results.database_connection ? '‚úÖ Yes' : '‚ùå No'}\n`;
            if (results.database_connection_error) {
                statusMessage += `‚ö†Ô∏è Connection Error: ${results.database_connection_error}\n`;
            }
            
            statusMessage += `\nüìÅ Backup Directory: ${results.backup_directory ? '‚úÖ Writable' : '‚ùå Not Writable'}\n`;
            if (results.backup_directory_error) {
                statusMessage += `‚ö†Ô∏è Directory Error: ${results.backup_directory_error}\n`;
            }
            
            // Show detailed results in a modal or alert
            alert(statusMessage);
            
            if (results.pg_dump_available && results.database_connection && results.backup_directory) {
                showStatus('‚úÖ Database backup system is ready!', 'success');
            } else {
                showStatus('‚ö†Ô∏è Database backup system has issues. Check the test results above.', 'warning');
            }
        } else {
            showStatus('‚ùå Failed to test database backup system: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error testing database backup system:', error);
        showStatus('‚ùå Network error testing backup system: ' + error, 'error');
    });
}

function loadBackupFiles() {
    console.log('Loading backup files...');
    
    fetch('/api/list-database-backups', {
        method: 'GET',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayBackupFiles(data.files || []);
        } else {
            displayBackupFiles([]);
            if (data.error) {
                showStatus('‚ùå Failed to load backup files: ' + data.error, 'error');
            }
        }
    })
    .catch(error => {
        console.error('Error loading backup files:', error);
        displayBackupFiles([]);
        showStatus('‚ùå Network error loading backup files: ' + error, 'error');
    });
}

function displayBackupFiles(files) {
    const container = $('#backup-files-list');
    
    if (files.length === 0) {
        container.html(`
            <div style="text-align: center; padding: 40px; color: #656d76;">
                <i class="fas fa-database" style="font-size: 48px; margin-bottom: 16px; color: #d0d7de;"></i>
                <h5 style="color: #656d76; margin-bottom: 8px;">No Database Backups Found</h5>
                <p style="color: #656d76;">Create a database backup using the options above to see available backup files.</p>
            </div>
        `);
        return;
    }
    
    let html = `
        <div style="margin-bottom: 16px;">
            <h6 style="font-weight: 600; margin-bottom: 8px; color: #24292f;">
                <i class="fas fa-list"></i> Available Database Backups (${files.length})
            </h6>
        </div>
        <div style="display: grid; gap: 8px;">
    `;
    
    files.forEach((file, index) => {
        const fileSize = file.size ? formatFileSize(file.size) : 'Unknown size';
        const modifiedDate = file.modified ? new Date(file.modified).toLocaleString() : 'Unknown date';
        const fileIcon = getFileIcon(file.name);
        
        html += `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f6f8fa; border-radius: 6px; border: 1px solid #d0d7de;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span style="background: #24292f; color: white; width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600;">${index + 1}</span>
                    <div>
                        <div style="font-weight: 600; font-size: 14px; color: #24292f; margin-bottom: 4px;">
                            <i class="${fileIcon}" style="margin-right: 6px; color: #656d76;"></i>
                            ${file.name}
                        </div>
                        <div style="font-size: 12px; color: #656d76;">
                            Size: ${fileSize} ‚Ä¢ Created: ${modifiedDate}
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="downloadBackupFile('${file.name}')" class="btn-github" style="padding: 4px 12px; font-size: 12px;">
                        <i class="fas fa-download"></i> Download
                    </button>
                    <button onclick="deleteBackupFile('${file.name}')" class="btn-github btn-github-danger" style="padding: 4px 12px; font-size: 12px;">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </div>
        `;
    });
    
    html += `</div>`;
    
    container.html(html);
}

function getFileIcon(filename) {
    if (filename.endsWith('.sql')) return 'fas fa-database';
    if (filename.endsWith('.json')) return 'fas fa-file-code';
    if (filename.endsWith('.csv')) return 'fas fa-file-csv';
    if (filename.endsWith('.zip')) return 'fas fa-file-archive';
    return 'fas fa-file';
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function refreshBackupFiles() {
    showStatus('Refreshing backup files list...', 'info');
    loadBackupFiles();
}

function downloadBackupFile(filename) {
    console.log('Downloading backup file:', filename);
    
    showStatus(`Downloading ${filename}...`, 'info');
    
    fetch('/api/download-database-backup', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({filename: filename})
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.blob();
    })
    .then(blob => {
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showStatus(`‚úÖ ${filename} downloaded successfully`, 'success');
    })
    .catch(error => {
        console.error('Error downloading backup file:', error);
        showStatus(`‚ùå Failed to download ${filename}: ${error.message}`, 'error');
    });
}

function deleteBackupFile(filename) {
    console.log('Deleting backup file:', filename);
    
    if (!confirm(`Are you sure you want to delete ${filename}? This action cannot be undone.`)) {
        return;
    }
    
    showStatus(`Deleting ${filename}...`, 'info');
    
    fetch('/api/delete-database-backup', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({filename: filename})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus(`‚úÖ ${filename} deleted successfully`, 'success');
            loadBackupFiles(); // Refresh the list
        } else {
            showStatus(`‚ùå Failed to delete ${filename}: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error deleting backup file:', error);
        showStatus(`‚ùå Failed to delete ${filename}: ${error.message}`, 'error');
    });
}

function cleanupOldBackups() {
    console.log('Cleaning up old backup files...');
    
    if (!confirm('Are you sure you want to delete old backup files? This will keep only the 5 most recent backups.')) {
        return;
    }
    
    showStatus('Cleaning up old backup files...', 'info');
    
    fetch('/api/cleanup-old-backups', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus(`‚úÖ Cleanup completed. Deleted ${data.deleted_count} old backup files.`, 'success');
            loadBackupFiles(); // Refresh the list
        } else {
            showStatus(`‚ùå Failed to cleanup old backups: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error cleaning up old backups:', error);
        showStatus(`‚ùå Failed to cleanup old backups: ${error.message}`, 'error');
    });
}

// Restore functionality functions
function loadBackupList() {
    console.log('Loading backup list for restore...');
    
    fetch('/api/list-backups', {
        method: 'GET',
        headers: {'Content-Type': 'application/json'}
    })
    .then(response => response.json())
    .then(data => {
        const select = $('#backup_select');
        select.empty();
        
        if (data.success && data.backups && data.backups.length > 0) {
            select.append('<option value="">Select a backup file...</option>');
            data.backups.forEach(backup => {
                const fileSize = backup.size ? formatFileSize(backup.size) : 'Unknown size';
                const modifiedDate = backup.modified ? new Date(backup.modified).toLocaleString() : 'Unknown date';
                select.append(`<option value="${backup.name}">${backup.name} (${fileSize}, ${modifiedDate})</option>`);
            });
        } else {
            select.append('<option value="">No backup files found</option>');
        }
    })
    .catch(error => {
        console.error('Error loading backup list:', error);
        const select = $('#backup_select');
        select.empty();
        select.append('<option value="">Error loading backup list</option>');
    });
}

function restoreDatabase() {
    const method = $('input[name="restore_method"]:checked').val();
    
    if (method === 'existing') {
        const selectedBackup = $('#backup_select').val();
        if (!selectedBackup) {
            showStatus('Please select a backup file to restore', 'error');
            return;
        }
        
        // Show progress
        $('#restore-progress').show();
        $('#restore-progress-text').text('Restoring from existing backup...');
        $('#restore-progress-bar').css('width', '20%');
        
        // Call restore API
        fetch('/api/restore-backup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                backup_file: selectedBackup
            })
        })
        .then(response => response.json())
        .then(data => {
            $('#restore-progress-bar').css('width', '100%');
            $('#restore-progress-text').text('Restore completed!');
            
            setTimeout(() => {
                $('#restore-progress').hide();
                if (data.success) {
                    showStatus('‚úÖ Database restored successfully!', 'success');
                    // Refresh backup list
                    loadBackupList();
                } else {
                    showStatus('‚ùå Restore failed: ' + data.error, 'error');
                }
            }, 1000);
        })
        .catch(error => {
            $('#restore-progress').hide();
            console.error('Error restoring database:', error);
            showStatus('‚ùå Network error during restore: ' + error.message, 'error');
        });
        
    } else if (method === 'upload') {
        const fileInput = document.getElementById('backup_file');
        const file = fileInput.files[0];
        
        if (!file) {
            showStatus('Please select a backup file to upload', 'error');
            return;
        }
        
        // Log file info for debugging
        console.log('File selected:', {
            fileName: file.name,
            fileSize: file.size,
            fileSizeKB: (file.size / 1024).toFixed(2),
            fileSizeMB: (file.size / (1024 * 1024)).toFixed(2)
        });
        
        // Show progress
        $('#restore-progress').show();
        $('#restore-progress-text').text('Converting file to text format...');
        $('#restore-progress-bar').css('width', '10%');
        
        // Use chunked base64 encoding to bypass file upload limits entirely
        const reader = new FileReader();
        reader.onload = function(e) {
            const base64Content = e.target.result.split(',')[1]; // Remove data:application/octet-stream;base64, prefix
            
            $('#restore-progress-text').text('Preparing chunked upload...');
            $('#restore-progress-bar').css('width', '20%');
            
            // Split base64 content into smaller chunks (500KB each)
            const chunkSize = 500 * 1024; // 500KB chunks
            const totalChunks = Math.ceil(base64Content.length / chunkSize);
            
            console.log(`Base64 content length: ${base64Content.length}, Total chunks: ${totalChunks}`);
            
            uploadBase64InChunks(base64Content, file.name, file.size, chunkSize, totalChunks);
        };
        
        reader.onerror = function() {
            $('#restore-progress').hide();
            showStatus('‚ùå Failed to read file', 'error');
        };
        
        reader.readAsDataURL(file);
        return;
        
        // Call upload restore API
        fetch('/api/upload-restore-backup', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                return response.text().then(text => {
                    console.error('Non-JSON response:', text);
                    throw new Error('Server returned non-JSON response. This might be an error page.');
                });
            }
            
            return response.json();
        })
        .then(data => {
            $('#restore-progress-bar').css('width', '100%');
            $('#restore-progress-text').text('Upload and restore completed!');
            
            setTimeout(() => {
                $('#restore-progress').hide();
                if (data.success) {
                    showStatus('‚úÖ Backup uploaded and database restored successfully!', 'success');
                    // Clear file input
                    fileInput.value = '';
                    // Refresh backup list
                    loadBackupList();
                } else {
                    showStatus('‚ùå Upload/restore failed: ' + data.error, 'error');
                }
            }, 1000);
        })
        .catch(error => {
            console.error('Direct upload failed:', error);
            
            // If direct upload fails with 413, try chunked upload as fallback
            if (error.message.includes('413') || error.message.includes('Request Entity Too Large')) {
                showStatus('üì§ Direct upload failed, trying chunked upload...', 'info');
                uploadFileInChunks(file, 512 * 1024, Math.ceil(file.size / (512 * 1024))); // 512KB chunks
            } else {
                $('#restore-progress').hide();
                showStatus('‚ùå Network error during upload/restore: ' + error.message, 'error');
            }
        });
    }
}

function refreshBackupList() {
    loadBackupList();
    showStatus('üîÑ Backup list refreshed', 'info');
}

function testChunkedUpload() {
    console.log('Testing chunked upload system...');
    
    fetch('/api/test-chunked-upload', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => {
        console.log('Test response status:', response.status);
        console.log('Test response headers:', response.headers);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            return response.text().then(text => {
                console.error('Test chunked upload - Non-JSON response:', text);
                throw new Error('Server returned non-JSON response. This might be an error page.');
            });
        }
        
        return response.json();
    })
    .then(data => {
        console.log('Test chunked upload success:', data);
        showStatus('‚úÖ Chunked upload system is working: ' + data.message, 'success');
    })
    .catch(error => {
        console.error('Test chunked upload error:', error);
        showStatus('‚ùå Chunked upload system test failed: ' + error.message, 'error');
    });
}

function uploadBase64InChunks(base64Content, filename, fileSize, chunkSize, totalChunks) {
    let currentChunk = 0;
    const uploadId = 'base64_upload_' + Date.now();
    
    function uploadNextChunk() {
        if (currentChunk >= totalChunks) {
            // All chunks uploaded, now restore
            $('#restore-progress-text').text('All chunks uploaded, restoring database...');
            $('#restore-progress-bar').css('width', '90%');
            
            // Call restore API with upload ID
            fetch('/api/restore-from-base64-chunks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    upload_id: uploadId,
                    filename: filename,
                    total_chunks: totalChunks,
                    file_size: fileSize
                })
            })
            .then(response => {
                console.log('Restore from base64 chunks response status:', response.status);
                console.log('Restore from base64 chunks response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    return response.text().then(text => {
                        console.error('Restore from base64 chunks - Non-JSON response:', text);
                        throw new Error('Server returned non-JSON response for restore. This might be an error page.');
                    });
                }
                
                return response.json();
            })
            .then(data => {
                $('#restore-progress-bar').css('width', '100%');
                $('#restore-progress-text').text('Restore completed!');
                
                setTimeout(() => {
                    $('#restore-progress').hide();
                    if (data.success) {
                        showStatus('‚úÖ Database restored successfully from chunked base64 upload!', 'success');
                        // Clear file input
                        document.getElementById('backup_file').value = '';
                        // Refresh backup list
                        loadBackupList();
                    } else {
                        showStatus('‚ùå Restore failed: ' + data.error, 'error');
                    }
                }, 1000);
            })
            .catch(error => {
                $('#restore-progress').hide();
                console.error('Error restoring from base64 chunks:', error);
                showStatus('‚ùå Restore failed: ' + error.message, 'error');
            });
            return;
        }
        
        const start = currentChunk * chunkSize;
        const end = Math.min(start + chunkSize, base64Content.length);
        const chunk = base64Content.substring(start, end);
        
        const progress = ((currentChunk + 1) / totalChunks) * 80; // 80% for upload, 20% for restore
        $('#restore-progress-bar').css('width', progress + '%');
        $('#restore-progress-text').text(`Uploading base64 chunk ${currentChunk + 1} of ${totalChunks}...`);
        
        fetch('/api/upload-base64-chunk', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                upload_id: uploadId,
                chunk_index: currentChunk,
                total_chunks: totalChunks,
                filename: filename,
                chunk_content: chunk
            })
        })
        .then(response => {
            console.log('Base64 chunk upload response status:', response.status);
            console.log('Base64 chunk upload response headers:', response.headers);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                return response.text().then(text => {
                    console.error('Base64 chunk upload - Non-JSON response:', text);
                    throw new Error('Server returned non-JSON response for chunk upload. This might be an error page.');
                });
            }
            
            return response.json();
        })
        .then(data => {
            if (data.success) {
                currentChunk++;
                uploadNextChunk();
            } else {
                throw new Error(data.error);
            }
        })
        .catch(error => {
            $('#restore-progress').hide();
            console.error('Error uploading base64 chunk:', error);
            showStatus('‚ùå Chunked base64 upload failed: ' + error.message, 'error');
        });
    }
    
    uploadNextChunk();
}

function uploadFileInChunks(file, chunkSize, totalChunks) {
    let currentChunk = 0;
    const uploadId = 'upload_' + Date.now();
    
    function uploadNextChunk() {
        if (currentChunk >= totalChunks) {
            // All chunks uploaded, now restore
            $('#restore-progress-text').text('All chunks uploaded, restoring database...');
            $('#restore-progress-bar').css('width', '90%');
            
            // Call restore API with upload ID
            fetch('/api/restore-from-chunks', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    upload_id: uploadId,
                    filename: file.name,
                    total_chunks: totalChunks
                })
            })
            .then(response => {
                console.log('Restore from chunks response status:', response.status);
                console.log('Restore from chunks response headers:', response.headers);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    return response.text().then(text => {
                        console.error('Restore from chunks - Non-JSON response:', text);
                        throw new Error('Server returned non-JSON response for restore. This might be an error page.');
                    });
                }
                
                return response.json();
            })
            .then(data => {
                $('#restore-progress-bar').css('width', '100%');
                $('#restore-progress-text').text('Restore completed!');
                
                setTimeout(() => {
                    $('#restore-progress').hide();
                    if (data.success) {
                        showStatus('‚úÖ Database restored successfully from chunked upload!', 'success');
                        // Clear file input
                        document.getElementById('backup_file').value = '';
                        // Refresh backup list
                        loadBackupList();
                    } else {
                        showStatus('‚ùå Restore failed: ' + data.error, 'error');
                    }
                }, 1000);
            })
            .catch(error => {
                $('#restore-progress').hide();
                console.error('Error restoring from chunks:', error);
                showStatus('‚ùå Restore failed: ' + error.message, 'error');
            });
            return;
        }
        
        const start = currentChunk * chunkSize;
        const end = Math.min(start + chunkSize, file.size);
        const chunk = file.slice(start, end);
        
        const formData = new FormData();
        formData.append('chunk', chunk);
        formData.append('upload_id', uploadId);
        formData.append('chunk_index', currentChunk);
        formData.append('total_chunks', totalChunks);
        formData.append('filename', file.name);
        
        const progress = ((currentChunk + 1) / totalChunks) * 80; // 80% for upload, 20% for restore
        $('#restore-progress-bar').css('width', progress + '%');
        $('#restore-progress-text').text(`Uploading chunk ${currentChunk + 1} of ${totalChunks}...`);
        
        fetch('/api/upload-chunk', {
            method: 'POST',
            body: formData
        })
        .then(response => {
            console.log('Chunk upload response status:', response.status);
            console.log('Chunk upload response headers:', response.headers);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                return response.text().then(text => {
                    console.error('Chunk upload - Non-JSON response:', text);
                    throw new Error('Server returned non-JSON response for chunk upload. This might be an error page.');
                });
            }
            
            return response.json();
        })
        .then(data => {
            if (data.success) {
                currentChunk++;
                uploadNextChunk();
            } else {
                throw new Error(data.error);
            }
        })
        .catch(error => {
            $('#restore-progress').hide();
            console.error('Error uploading chunk:', error);
            showStatus('‚ùå Chunked upload failed: ' + error.message, 'error');
        });
    }
    
    uploadNextChunk();
}

// OTP SSH Configuration Functions
function saveOTPSSHConfiguration() {
    console.log('Saving OTP SSH configuration...');
    
    const config = {
        host: $('#otp_server_host').val().trim(),
        port: parseInt($('#otp_server_port').val()),
        username: $('#otp_server_username').val().trim(),
        auth_method: $('#otp_server_auth_method').val(),
        password: $('#otp_server_password').val(),
        private_key: $('#otp_server_private_key').val().trim()
    };
    
    // Validate required fields
    if (!config.host || !config.username) {
        showStatus('Please fill in all required fields', 'error');
        return;
    }
    
    if (config.auth_method === 'password' && !config.password) {
        showStatus('Password is required when using password authentication', 'error');
        return;
    }
    
    if (config.auth_method === 'key' && !config.private_key) {
        showStatus('Private key is required when using SSH key authentication', 'error');
        return;
    }
    
    showStatus('Saving OTP SSH configuration...', 'info');
    
    fetch('/api/save-otp-ssh-config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('‚úÖ OTP SSH configuration saved successfully', 'success');
            loadCurrentConfiguration();
        } else {
            showStatus('‚ùå Failed to save OTP configuration: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error saving OTP configuration:', error);
        showStatus('‚ùå Network error: ' + error, 'error');
    });
}

function testOTPServerConnection() {
    console.log('Testing OTP server connection...');
    
    const config = {
        host: $('#otp_server_host').val().trim(),
        port: parseInt($('#otp_server_port').val()),
        username: $('#otp_server_username').val().trim(),
        auth_method: $('#otp_server_auth_method').val(),
        password: $('#otp_server_password').val(),
        private_key: $('#otp_server_private_key').val().trim()
    };
    
    // Validate required fields
    if (!config.host || !config.username) {
        showStatus('Please fill in all required fields before testing', 'error');
        return;
    }
    
    if (config.auth_method === 'password' && !config.password) {
        showStatus('Password is required when using password authentication', 'error');
        return;
    }
    
    if (config.auth_method === 'key' && !config.private_key) {
        showStatus('Private key is required when using SSH key authentication', 'error');
        return;
    }
    
    showStatus('Testing OTP server connection...', 'info');
    
    fetch('/api/test-otp-server-connection', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(config)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showStatus('‚úÖ ' + data.message, 'success');
        } else {
            showStatus('‚ùå OTP server connection failed: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error testing OTP connection:', error);
        showStatus('‚ùå Network error: ' + error.message, 'error');
    });
}
</script>
{% endblock %}
